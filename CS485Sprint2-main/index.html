<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Aldrich|Arima+Madurai|Arvo|Henny+Penny|Indie+Flower|Libre+Baskerville|Pirata+One|Poiret+One|Sancreek|Satisfy|Share+Tech+Mono|Smokum|Snowburst+One|Special+Elite"
          rel="stylesheet">
    <path d="M0,0C27.272727272727273,0,27.272727272727273,-80.78125,54.54545454545455,-80.78125"></path>
</head>
<style type="text/css">

</style>
<body>

<script type="text/javascript">

    // Promise.all([
    //     d3.csv('billionaires1996.csv')
    // ]).then(ready);
    var count = 0
    ready()
    async function ready() {
        //python -m http.server 8888
        var chart = d3.interval(async function () {
            let updatedData =  await preprocess();
            update(updatedData);
        },8000);
    }

      async function preprocess() {
        if(count===0){
            count = count + 1
            var d = await d3.csv('billionaires1996.csv')
            return  d;
        }
        else if (count === 1) {
            count = count + 1
            var d = await d3.csv('billionaires2001.csv')
            return d
        } else if (count === 2) {
            count = count + 1
            var d = await d3.csv('billionaires2014.csv')
            return d

        } else if (count === 3) {
            count = count + 1
            var d = await d3.csv('billionairesCleanedNoColumn.csv')
            return d
        }
    }

    const WIDTH = 1000;
    const HEIGHT = 500;
    const INNER_HEIGHT = HEIGHT - 20;
    const BAR_WIDTH = 24;
    const BAR_GAP = 5;

    const scale = d3.scaleLinear()
        .domain([0, 1000])
        .range([0, INNER_HEIGHT]);

    function y(d) {
        return HEIGHT - scale(d.wealth);
    }

    function height(d) {
        return scale(d.wealth);
    }

    const svg = d3.select("body").append("svg")
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .append("g");

    async function update(data) {
        console.log(data)

        const t = d3.transition()
            .duration(7500);

        const bar = svg.selectAll("g")
            .data(data);

        // EXIT section
        bar
            .exit()
            .remove();

        // UPDATE section
        bar
            .transition(t)
            .attr("transform", (d, i) => `translate(${i * (BAR_WIDTH + BAR_GAP)},${y(d)})`);

        bar.select("rect")
            .transition(t)
            .attr("height", HEIGHT);

        bar.select("text")
            .transition(t)
            .tween("text", function (d) {
                const v0 = this.textContent || "0";
                const v1 = d.wealth;
                const i = d3.interpolateRound(v0, v1);
                return t => this.textContent = i(t);
            });

        // ENTER section
        const barEnter = bar
            .enter().append("g")
            .attr("transform", (d, i) => `translate(${i * (BAR_WIDTH + BAR_GAP)},${INNER_HEIGHT})`);

        barEnter
            .transition(t)
            .attr("transform", (d, i) => `translate(${i * (BAR_WIDTH + BAR_GAP)},${y(d)})`);

        const rect = barEnter.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", BAR_WIDTH)
            .attr("height", 0);

        rect
            .transition(t)
            .attr("height", height);

        const text = barEnter.append("text")
            .text(d => d.industry)
            .attr("text-anchor", "middle")
            .attr("dx", BAR_WIDTH / 2)
            .attr("dy", -2);
    }

</script>

</body>
</html>